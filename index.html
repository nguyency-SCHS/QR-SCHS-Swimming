<!DOCTYPE html>
<html>
<head>
  <title>Location Restricted Login</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
    .allowed { color: green; font-size: 20px; }
    .denied { color: red; font-size: 20px; }
    #loginForm { display: none; margin-top: 20px; }
    input { margin: 5px; padding: 5px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <h2>QR Code Location Login</h2>
  <div id="status">Checking your location...</div>

  <form id="loginForm">
    <input type="text" id="name" placeholder="Enter your name" required>
    <input type="text" id="id" placeholder="Enter your ID" required>
    <button type="submit">Log In</button>
  </form>

  <script>
    // Allowed location (San Jose example)
    const allowedLat = 37.30389;
    const allowedLng = -121.80713;
    const allowedRadius = 100; // meters

    // Google Apps Script URL (replace with yours)
    const scriptURL = "YOUR_GOOGLE_APPS_SCRIPT_WEBAPP_URL";

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const distance = getDistance(
          allowedLat, allowedLng,
          pos.coords.latitude, pos.coords.longitude
        );

        if (distance <= allowedRadius) {
          document.getElementById("status").innerHTML =
            "<p class='allowed'>✅ Access Granted</p>";
          document.getElementById("loginForm").style.display = "block";
        } else {
          document.getElementById("status").innerHTML =
            "<p class='denied'>❌ You are not in the allowed location</p>";
        }
      }, () => {
        document.getElementById("status").innerHTML =
          "<p class='denied'>⚠️ Location access denied</p>";
      });
    } else {
      document.getElementById("status").innerHTML =
        "<p class='denied'>❌ Geolocation not supported</p>";
    }

    // Submit login to Google Sheets
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const data = {
        name: document.getElementById("name").value,
        id: document.getElementById("id").value,
        location: "Access Granted"
      };

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(response => alert("✅ Login recorded"))
      .catch(error => alert("❌ Error: " + error));
    });
  </script>
</body>
</html>
